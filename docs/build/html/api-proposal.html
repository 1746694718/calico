<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Calico API Design &mdash; Project Calico 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Project Calico 0.0.1 documentation" href="index.html" />
    <link rel="prev" title="Frequently Asked Questions" href="faq.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="faq.html" title="Frequently Asked Questions"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Project Calico 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="calico-api-design">
<h1>Calico API Design<a class="headerlink" href="#calico-api-design" title="Permalink to this headline">¶</a></h1>
<p><em>Author&#8217;s Note: This is a work in progress with some known issues. If
something in this document strikes you as odd, please consult the list
of outstanding issues at the bottom of the document before commenting.
However, if it&#8217;s not already mentioned, please do comment through our
`mailing list &lt;http://lists.projectcalico.org/listinfo/calico&gt;`__ and
`community &lt;http://www.projectcalico.org/community/&gt;`__. Feedback is
welcomed!</em></p>
<p>A simplified diagram of the current Calico architecture plan looks like
this:</p>
<div class="figure">
<img alt="The Calico Architecture" src="_images/calico_API_arch_Sept_2014.png" />
<p class="caption">The Calico Architecture</p>
</div>
<p>More information on the components of this architecture can be found
in <a class="reference internal" href="arch-felix-and-acl.html"><em>Calico Component Architecture</em></a>.
This document covers the concepts used in the three APIs shown in the
above diagram.</p>
<p>The Calico API is conceptually divided into three parts: the Calico
Endpoint API, the Calico ACL API, and the Calico Network API. Each
portion communicates different information. The Calico Endpoint API
communicates data <em>about</em> endpoints (such as their IP addresses, MAC
addresses and so on), as well as for endpoint discovery. The Calico ACL
API communicates the state of ACLs for a given endpoint. The Calico
Network API communicates the virtual network topology to the ACL
manager.</p>
<p>Felix (or other agents) implements both the Endpoint API and the ACL
API. The Calico Plugin (or the orchestration system, if Calico is
deployed directly into the system) implements the Endpoint API. The
Calico ACL Manager (or any component replacing it) implements the ACL
API and the Network API.</p>
<p>Each of these APIs is given separate treatment below.</p>
<div class="section" id="general-api-format">
<h2>General API Format<a class="headerlink" href="#general-api-format" title="Permalink to this headline">¶</a></h2>
<p>Each API endpoint details a <em>type</em> and a <em>body</em>. The body of each
message is JSON-formatted. The <em>body</em> section of each API endpoint
document lists all the fields that are in the message body. These fields
are all mandatory and may not be <tt class="docutils literal"><span class="pre">null</span></tt> unless explicitly mentioned.
In addition to the <em>body</em> fields, each message body must also include
its <em>type</em>.</p>
</div>
<div class="section" id="calico-endpoint-api">
<h2>Calico Endpoint API<a class="headerlink" href="#calico-endpoint-api" title="Permalink to this headline">¶</a></h2>
<p>The Calico Endpoint API communicates information about endpoints and
notifies components about the state of individual endpoints.</p>
<p>This API is based on a request-response model, but <em>not</em> a client-server
model. Requests and responses can flow in either direction, depending on
the particular orchestration system being used.</p>
<p>The Calico Endpoint API is transported using ZeroMQ&#8217;s REQ-REP socket
logic. Each peer involved SHOULD have one sending (REQ or DEALER) socket
and one receiving (REP or ROUTER) socket. Each peer MUST accept requests
from any number of peers. Each peer MAY send requests to any number of
peers (to balance load or perform HA function), but there is no
requirement to do so.</p>
<div class="section" id="stories">
<h3>Stories<a class="headerlink" href="#stories" title="Permalink to this headline">¶</a></h3>
<p>The following stories provide a high-level overview of the kinds of
messages that are passed on the Endpoint API. They are not intended as
an exhaustive enumeration of everything that can possibly be done on the
Endpoint API but as a useful guideline.</p>
<div class="section" id="story-1-endpoint-creation">
<h4>Story 1: Endpoint Creation<a class="headerlink" href="#story-1-endpoint-creation" title="Permalink to this headline">¶</a></h4>
<p>This story covers the case where a new endpoint is to be programmed in
an environment where the Calico Plug-in is responsible for endpoint
creation. The flow is approximately as follows:</p>
<ol class="arabic">
<li><p class="first">A new endpoint is created by a user.</p>
</li>
<li><p class="first">The Calico Plug-in is informed of the endpoint creation event. It
collates all the data associated with the endpoint creation and
bundles it together into an &#8220;ENDPOINTCREATED&#8221; request, which it sends
to one of the registered Felixes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTCREATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;interface_name&quot;</span><span class="p">:</span> <span class="s">&quot;tapa935e8e1-00&quot;</span><span class="p">,</span>
  <span class="s">&quot;addrs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">&quot;addr&quot;</span><span class="p">:</span> <span class="s">&quot;10.0.65.2&quot;</span><span class="p">,</span> <span class="s">&quot;gateway&quot;</span><span class="p">:</span> <span class="s">&quot;10.65.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gr&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">}},</span>
  <span class="p">],</span>
  <span class="s">&quot;mac&quot;</span><span class="p">:</span> <span class="s">&quot;00:11:22:33:44:55&quot;</span><span class="p">,</span>
  <span class="s">&quot;state&quot;</span><span class="p">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">,</span>
  <span class="s">&quot;resync_id&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Felix receives the message and locates the interface. It then
programs the routing layers appropriately and sets up the necessary
control structures. It sends the &#8220;ENDPOINTCREATED&#8221; response:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTCREATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;rc&quot;</span><span class="p">:</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">,</span>
  <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="story-2-endpoint-state-update">
<h4>Story 2: Endpoint State Update<a class="headerlink" href="#story-2-endpoint-state-update" title="Permalink to this headline">¶</a></h4>
<p>The Calico Plug-in may decide at any time to disable an endpoint. When
that is done Felix should remove that endpoint from any networks in
which it is present, and may take this opportunity to simplify its own
internal state. In essence, the interface will be left present and
managed by Felix, but no programming will be entered into the system
(i.e. the route will not be advertised).</p>
<p>This occurs as follows:</p>
<ol class="arabic">
<li><p class="first">The user deactivates their endpoint (e.g. to take a filesystem
snapshot).</p>
</li>
<li><p class="first">The Calico Plug-in is informed of the endpoint deactivation event. It
sends the Felix that manages the endpoint an &#8220;ENDPOINTUPDATED&#8221;
request, as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTUPDATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;addrs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">&quot;addr&quot;</span><span class="p">:</span> <span class="s">&quot;10.0.65.2&quot;</span><span class="p">,</span> <span class="s">&quot;gateway&quot;</span><span class="p">:</span> <span class="s">&quot;10.65.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gr&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">}},</span>
  <span class="p">],</span>
  <span class="s">&quot;mac&quot;</span><span class="p">:</span> <span class="s">&quot;00:11:22:33:44:55&quot;</span><span class="p">,</span>
  <span class="s">&quot;state&quot;</span><span class="p">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Felix receives the message. If any programming is present on the
system, it removes it. It keeps track of the interface itself, and
continues to include it in any list of managed interfaces. It sends a
response:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTUPDATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;rc&quot;</span><span class="p">:</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">,</span>
  <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Some time later, the user re-activates the endpoint. The Calico
Plug-in sends a new &#8220;ENDPOINTUPDATED&#8221; message:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTUPDATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;addrs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">&quot;addr&quot;</span><span class="p">:</span> <span class="s">&quot;10.0.65.2&quot;</span><span class="p">,</span> <span class="s">&quot;gateway&quot;</span><span class="p">:</span> <span class="s">&quot;10.65.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gr&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">}},</span>
  <span class="p">],</span>
  <span class="s">&quot;mac&quot;</span><span class="p">:</span> <span class="s">&quot;00:11:22:33:44:55&quot;</span><span class="p">,</span>
  <span class="s">&quot;state&quot;</span><span class="p">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>More generally, this exact mechanism can be used whenever any property
of the endpoint is changed. It allows for on-the-fly remapping of
endpoint IP addresses, without any requirement to deactivate the
endpoint.</p>
</div>
<div class="section" id="story-3-failed-endpoint-allocation">
<h4>Story 3: Failed Endpoint Allocation<a class="headerlink" href="#story-3-failed-endpoint-allocation" title="Permalink to this headline">¶</a></h4>
<p>As an elaboration on Story 1, the Calico Plug-in may attempt to create
an endpoint, but Felix may encounter an error condition. In this case,
the following flow occurs:</p>
<ol class="arabic">
<li><p class="first">A new endpoint is created by a user.</p>
</li>
<li><p class="first">The Calico Plug-in is informed of the endpoint creation event. It
collates all the data associated with the endpoint creation and
bundles it together into an &#8220;ENDPOINTCREATED&#8221; request, which it sends
to one of the registered Felixes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTCREATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;interface_name&quot;</span><span class="p">:</span> <span class="s">&quot;tapa935e8e1-00&quot;</span><span class="p">,</span>
  <span class="s">&quot;addrs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s">&quot;addr&quot;</span><span class="p">:</span> <span class="s">&quot;10.0.65.2&quot;</span><span class="p">,</span> <span class="s">&quot;gateway&quot;</span><span class="p">:</span> <span class="s">&quot;10.65.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gr&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">}},</span>
  <span class="p">],</span>
  <span class="s">&quot;mac&quot;</span><span class="p">:</span> <span class="s">&quot;00:11:22:33:44:55&quot;</span><span class="p">,</span>
  <span class="s">&quot;state&quot;</span><span class="p">:</span> <span class="s">&quot;enabled&quot;</span><span class="p">,</span>
  <span class="s">&quot;resync_id&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Felix receives the message and locates the interface. An immediate
error occurs (for example, Felix cannot locate the interface), and it
reports the error back:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;ENDPOINTCREATED&quot;</span><span class="p">,</span>
  <span class="s">&quot;rc&quot;</span><span class="p">:</span> <span class="s">&quot;ENOINTERFACE&quot;</span><span class="p">,</span>
  <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Unable to locate interface: permission denied&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that if Felix is not running (for example, because it has failed
or been manually stopped) then the Calico Plug-in treats the lack of
a timely response as a failure.</p>
</li>
<li><p class="first">The Calico Plug-in must then handle this failure. For example, in the
OpenStack case, the behavior is to report the error back to
<tt class="docutils literal"><span class="pre">neutron</span></tt> which then marks the endpoint as failed, and retries as
appropriate; other Plug-ins may choose to behave differently.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="detailed-api-description">
<h3>Detailed API Description<a class="headerlink" href="#detailed-api-description" title="Permalink to this headline">¶</a></h3>
<div class="section" id="request-response">
<h4>Request-Response<a class="headerlink" href="#request-response" title="Permalink to this headline">¶</a></h4>
<div class="section" id="request-endpointcreated">
<h5>Request: ENDPOINTCREATED<a class="headerlink" href="#request-endpointcreated" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt></li>
<li><strong>Direction</strong>: Plugin → Felix</li>
<li><strong>Body</strong>: An <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt> request has the following properties
in its body:<ul>
<li><em>endpoint_id</em>: A UUID4 uniquely identifying the endpoint.</li>
<li><em>interface_name</em>: The name of the interface; for example, in
OpenStack this can be constructed by taking the first 11
characters of the endpoint_id and prepending the string &#8220;tap&#8221;.</li>
<li><em>addrs</em>: A list of all IP addresses assigned to this particular
endpoint in the IP Address format described below.</li>
<li><em>mac</em>: The MAC address of the interface assigned to the endpoint.
This MAC address is not visible to other machines in the data
center (as Calico virtualises networks at layer 3), but is used to
prevent MAC spoofing.</li>
<li><em>state</em>: The state of the endpoint. A string with two possible
values, &#8220;enabled&#8221; and &#8220;disabled&#8221;. A endpoint that is &#8220;enabled&#8221; is
reachable on its virtual network: an endpoint that is &#8220;disabled&#8221;
is not.</li>
<li><em>resync_id</em>: The ID number of the &#8220;RESYNCSTATE&#8221; message which
triggered this message. It is only used when a Felix instance has
requested state resynchronisation, and is used to disambiguated
messages that are triggered by such a request from other
ENDPOINTCREATED messages. Should be <tt class="docutils literal"><span class="pre">null</span></tt> if this message is
not triggered by a &#8220;RESYNCSTATE&#8221; message.</li>
<li><em>issued</em>: A unix timestamp with millisecond or better precision
corresponding to the time the request was issued.</li>
</ul>
</li>
</ul>
<p>This request is an indication that the plugin or orchestrator has
created a new endpoint, and is instructing this Felix to manage its
networking. It is used both to request endpoint creation, and is used in
all systems to carry data about an endpoint if Felix has requested state
resynchronisation (see the &#8220;RESYNCSTATE&#8221; message below).</p>
<p>When state resynchronisation is in progress, no <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt>
messages for new endpoint creation (i.e. with <em>resnyc_id</em> equal to
<tt class="docutils literal"><span class="pre">null</span></tt>) can be sent until the state resynchronisation has completed.</p>
</div>
<div class="section" id="response-endpointcreated">
<h5>Response: ENDPOINTCREATED<a class="headerlink" href="#response-endpointcreated" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt></li>
<li><strong>Direction</strong>: Felix → Plugin</li>
<li><strong>Body</strong>: An <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt> response has the following
properties in its body:<ul>
<li><em>rc</em>: A return code, as a string. The list of valid return codes
is provided as an appendix to this document.</li>
<li><em>message</em>: A free-form text field containing extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
<p>This response reports whether the endpoint creation is possible. In some
situations Felix may know that it cannot create an endpoint (e.g.
because of some systemic server failure, or an internal error in Felix).
Felix can use the error code in this message to report that status to
the plugin.</p>
<p>Note that this response is returned almost immediately after the
request: Felix does not wait for the interface to be fully programmed.
This would take too long. This means that errors encountered in the
interface creation process are not reported on this interface.</p>
</div>
<div class="section" id="request-endpointupdated">
<h5>Request: ENDPOINTUPDATED<a class="headerlink" href="#request-endpointupdated" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTUPDATED</span></tt></li>
<li><strong>Direction</strong>: Plugin → Felix</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">ENDPOINTUPDATED</span></tt> request has the following properties
in its body:<ul>
<li><em>endpoint_id</em>: A UUID4 uniquely identifying the endpoint. Felix
must be able to determine the name of the tap interface from this
UUID by taking the first 9 characters of the UUID and prepending
the string &#8220;tap&#8221;.</li>
<li><em>addrs</em>: A list of all IP addresses assigned to this particular
endpoint in the IP Address format described below.</li>
<li><em>mac</em>: The MAC address of the interface assigned to the endpoint.
This MAC address is not visible to other machines in the data
center (as Calico virtualises networks at layer 3), but is used to
prevent MAC spoofing.</li>
<li><em>state</em>: The state of the endpoint. A string with two possible
values, &#8220;enabled&#8221; and &#8220;disabled&#8221;. A endpoint that is &#8220;enabled&#8221; is
reachable on its virtual network: an endpoint that is &#8220;disabled&#8221;
is not.</li>
<li><em>issued</em>: A unix timestamp with millisecond or better precision
corresponding to the time the request was issued.</li>
</ul>
</li>
</ul>
<p>This request asks Felix to update the state of a given endpoint. Any of
the body fields (aside from <em>issued</em>) may be changed from the current
state of the endpoint and Felix will update the configuration to reflect
the change.</p>
</div>
<div class="section" id="response-endpointupdated">
<h5>Response: ENDPOINTUPDATED<a class="headerlink" href="#response-endpointupdated" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTUPDATED</span></tt></li>
<li><strong>Direction</strong>: Felix → Plugin</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">ENDPOINTUPDATED</span></tt> response has the following properties
in its body:<ul>
<li><em>rc</em>: A return code, as a string. The list of valid return codes
is provided as an appendix to this document.</li>
<li><em>message</em>: A free-form text field containing extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
<p>This response reflects whether Felix was capable of updating the
configuration. In practice, this can never fail.</p>
</div>
<div class="section" id="request-endpointdestroyed">
<h5>Request: ENDPOINTDESTROYED<a class="headerlink" href="#request-endpointdestroyed" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTDESTROYED</span></tt></li>
<li><strong>Direction</strong>: Plugin → Felix</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">ENDPOINTDESTROYED</span></tt> request has the following
properties in its body:<ul>
<li><em>endpoint_id</em>: The UUID4 uniquely identifying the endpoint to
destroy.</li>
<li><em>issued</em>: A unix timestamp with millisecond or better precision
corresponding to the time the request was issued.</li>
</ul>
</li>
</ul>
<p>This request asks Felix to destroy an endpoint. It instructs Felix to
permanently remove all configuration for an interface, and to stop
managing it.</p>
</div>
<div class="section" id="response-endpointdestroyed">
<h5>Response: ENDPOINTDESTROYED<a class="headerlink" href="#response-endpointdestroyed" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ENDPOINTDESTROYED</span></tt></li>
<li><strong>Direction</strong>: Felix → Plugin</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">ENDPOINTDESTROYED</span></tt> request has the following
properties in its body:<ul>
<li><em>rc</em>: A return code, as a string. The list of valid return codes
is provided as an appendix to this document.</li>
<li><em>message</em>: A free-form text field containing extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
<p>This response reflects whether Felix was capable of removing the
configuration. In practice, this may never fail.</p>
</div>
<div class="section" id="request-resyncstate">
<h5>Request: RESYNCSTATE<a class="headerlink" href="#request-resyncstate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt></li>
<li><strong>Direction</strong>: Felix → Plugin</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt> request has the following properties in
its body:<ul>
<li><em>resync_id</em>: A unique string identifier for this state
resychronisation request. This identifier will be included on all
the triggered <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt> messages, and can be used to
identify them.</li>
<li><em>issued</em>: A unix timestamp with millisecond or better precision
corresponding to the time the request was issued.</li>
<li><em>hostname</em>: The hostname of the Felix issuing the request.</li>
</ul>
</li>
</ul>
<p>A <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt> message is issued whenever a Felix is started in a
plugin-led environment, and is only valid in such an environment. The
request causes the Plugin to re-issue all the <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt>
messages required to re-establish Felix state. This allows for Felix to
get into a correct state if for any reason it encounters an error or is
restarted.</p>
<p>Please note that <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt> is <em>not</em> intended to allow the Plugin
to process new endpoint creations successfully at a time when it is not
connected to a Felix on the relevant compute host, on the assumption
that the required Felix may shortly appear and connect to the Plugin. In
such a scenario, the Plugin should choose another compute host instead,
for which it does have an active Felix connection, or fail the endpoint
creation if no suitable compute hosts are available.</p>
</div>
<div class="section" id="response-resyncstate">
<h5>Response: RESYNCSTATE<a class="headerlink" href="#response-resyncstate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt></li>
<li><strong>Direction</strong>: Plugin → Felix</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">RESYNCSTATE</span></tt> response has the following properties in
its body:<ul>
<li><em>endpoint_count</em>: The number of <tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt> messages
Felix should expect to receive in response to its request.</li>
<li><em>interface_prefix</em>: The interface prefix. To identify which
endpoints it manages, Felix needs to know the unique starting
prefix (such as &#8220;tap&#8221; or &#8220;veth&#8221;) for all interface names passed on
<tt class="docutils literal"><span class="pre">ENDPOINTCREATED</span></tt> messages, and this is where that information
is supplied.</li>
<li><em>rc</em>: A return code indicating whether the Plugin is able to
rebuild the Felix state.</li>
<li><em>message</em>: A free-form text field containing extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="request-heartbeat">
<h5>Request: HEARTBEAT<a class="headerlink" href="#request-heartbeat" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt></li>
<li><strong>Direction</strong>: Plugin → Felix</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt> request has no body.</li>
</ul>
</div>
<div class="section" id="response-heartbeat">
<h5>Response: HEARTBEAT<a class="headerlink" href="#response-heartbeat" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt></li>
<li><strong>Direction</strong>: Felix → Plugin</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt> response has no body.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt> request is sent from the plugin to Felix if the
connection between the two has been inactive for 30 seconds. It, along
with its response, allows the plugin and Felix to confirm that the
connection between them is still active.</p>
</div>
</div>
<div class="section" id="structures">
<h4>Structures<a class="headerlink" href="#structures" title="Permalink to this headline">¶</a></h4>
<p>This section contains any data structures referenced in the above
documentation. For a data structure to be in this section it must be
sufficiently complex that it would interfere with the clarity of the
previous section.</p>
<div class="section" id="object-ip-address">
<h5>Object: IP Address<a class="headerlink" href="#object-ip-address" title="Permalink to this headline">¶</a></h5>
<p>An &#8220;IP Address&#8221; structure represents a single IP address assigned to an
endpoint. It takes the following form:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;addr&quot;: &lt;an IPv4 or IPv6 address, as a string&gt;
  &quot;gateway&quot;: &lt;the IPv4 or IPv6 address for the default gateway for this address, as a string&gt;,
  &quot;properties&quot;: &lt;a key-value list of properties assigned to this address&gt;
}
</pre></div>
</div>
<p>The <em>addr</em> and <em>gateway</em> values must both be the same kind of IP
address: it is an error to send a message with different address types
for the endpoint and the gateway in a single &#8220;IP Address&#8221; structure.</p>
<p>The <em>properties</em> key-value list defines all the properties assigned to a
single address. This is defined in an extensible format to allow
non-Felix agents to act on properties unique to a given operator. Felix
understands the following properties:</p>
<ul class="simple">
<li><em>gr</em>: Whether the address is globally routable (i.e. reachable from
outside the data center). Must be one of <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>. If
absent, defaults to <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="section" id="calico-acl-api">
<h2>Calico ACL API<a class="headerlink" href="#calico-acl-api" title="Permalink to this headline">¶</a></h2>
<p>The Calico ACL API communicates information about ACLs and notifies
components about changes to the deployment-wide ACL configuration.</p>
<p>This API is based on a combination request-response and
publish-subscribe model. The request-response portion of the API is used
for one-off synchronisation between Felix and the ACL manager, while the
publish-subscribe model is used for longer-term monitoring of changes to
ACL state. Requests can only flow from Felix to the ACL manager. The ACL
manager is the only entity that can publish: Felixes subscribe.</p>
<p>This API is transported by ZeroMQs REQ-REP and PUB-SUB socket logic.
Each Felix MUST have one sending (REQ or DEALER) socket. The ACL manager
must have one receiving (REP or ROUTER) socket, from which it will
accept connections from any number of Felixes. Additionally, each Felix
MUST have one SUB socket, and the ACL manager MUST have one PUB socket.</p>
<div class="section" id="id1">
<h3>Stories<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The following stories provide a high-level overview of the kinds of
messages that are passed on the ACL API. They are not intended as an
exhaustive enumeration of everything that can possibly be done on the
ACL API but as a useful guideline.</p>
<div class="section" id="story-1-acls-for-a-new-endpoint">
<h4>Story 1: ACLs for a New Endpoint<a class="headerlink" href="#story-1-acls-for-a-new-endpoint" title="Permalink to this headline">¶</a></h4>
<p>In this situation, Felix is provisioning a new endpoint. It needs a
snapshot of the current ACL state for that endpoint. It fetches this
information from the ACL manager using a request-response cycle.
Separately, it also subscribes to ACL updates for that endpoint.</p>
<ol class="arabic">
<li><p class="first">Felix issues a &#8220;GETACLSTATE&#8221; request to the ACL manager, passing the
interface ID of the endpoint.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GETACLSTATE&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The ACL manager determines that the request is for a valid endpoint,
and then returns success.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GETACLSTATE&quot;</span><span class="p">,</span>
  <span class="s">&quot;endpoint_id&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span>
  <span class="s">&quot;rc&quot;</span><span class="p">:</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">,</span>
  <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The ACL manager looks up the current state of the ACLs on the system.
It builds them into a form suitable for sending back to Felix, and
then immediately publishes them in an &#8220;ACLUPDATE&#8221; subscription to the
subscription whose name is the UUID of the affected endpoint.</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;type&quot;: &quot;ACLUPDATE&quot;,
  &quot;acls&quot;: &lt;ACL rules&gt;,
  &quot;issued&quot;: 1410276720.54
}
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="story-2-a-change-in-acl-state-of-an-endpoint">
<h4>Story 2: A change in ACL state of an endpoint<a class="headerlink" href="#story-2-a-change-in-acl-state-of-an-endpoint" title="Permalink to this headline">¶</a></h4>
<p>In this situation, an endpoint has had its ACL state changed (e.g.
security group rules have changed, or a new machine has been added to a
security group or network). The ACL manager has calculated the new ACL
state, and determined which machines are affected. The following flow
occurs.</p>
<ol class="arabic">
<li><p class="first">The ACL manager publishes an &#8220;ACLUPDATE&#8221; message to the subscription
whose name is the UUID of the affected endpoint.</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;type&quot;: &quot;ACLUPDATE&quot;,
  &quot;acls&quot;: &lt;ACL rules&gt;,
  &quot;issued&quot;: 1410276720.54
}
</pre></div>
</div>
<p>This message contains the full set of ACL rules for that endpoint,
<em>not</em> a delta. This is both for simplicity and to allow eventual
resynchronisation of state over time.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="id2">
<h3>Detailed API Description<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id3">
<h4>Request-Response<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="section" id="request-getaclstate">
<h5>Request: GETACLSTATE<a class="headerlink" href="#request-getaclstate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">GETACLSTATE</span></tt></li>
<li><strong>Direction</strong>: Felix → ACL Manager</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">GETACLSTATE</span></tt> request contains the fillowing fields in
its body:<ul>
<li><em>endpoint_id</em>: The UUID4 representing the endpoint whose ACLs
Felix is requesting.</li>
<li><em>issued</em>: A Unix timestamp with millisecond or better resolution
indicating when the request was issued.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="response-getaclstate">
<h5>Response: GETACLSTATE<a class="headerlink" href="#response-getaclstate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">GETACLSTATE</span></tt></li>
<li><strong>Direction</strong>: ACL Manager → Felix</li>
<li><strong>Body</strong>: A <tt class="docutils literal"><span class="pre">GETACLSTATE</span></tt> response contains the following fields in
its body:<ul>
<li><em>endpoint_id</em>: The UUID4 representing the endpoint whose ACLs
have been requested.</li>
<li><em>rc</em>: A return code indicating whether the ACL manager is going to
publish the current ACL state.</li>
<li><em>message</em>: A free-form text field carrying extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="pub-sub">
<h4>Pub-Sub<a class="headerlink" href="#pub-sub" title="Permalink to this headline">¶</a></h4>
<div class="section" id="publication-aclupdate">
<h5>Publication: ACLUPDATE<a class="headerlink" href="#publication-aclupdate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">ACLUPDATE</span></tt></li>
<li><strong>Direction</strong>: ACL Manager → Felix</li>
<li><strong>Body</strong>: An <tt class="docutils literal"><span class="pre">ACLUPDATE</span></tt> publication contains the following fields:<ul>
<li><em>acls</em>: An ACL collection object, as detailed below.</li>
<li><em>issued</em>: A Unix timestamp with millisecond or better precision
indicating when the publication was issued.</li>
</ul>
</li>
</ul>
<p>There is one <tt class="docutils literal"><span class="pre">ACLUPDATE</span></tt> subscription per endpoint in the network,
with the subscription name being set to the UUID of the endpoint. Each
time the ACL state of the endpoint changes an <tt class="docutils literal"><span class="pre">ACLUPDATE</span></tt> publication
is issued on that subscription, containing the complete ACL state of the
endpoint. These messages may also be triggered by a <tt class="docutils literal"><span class="pre">GETACLSTATE</span></tt>
request, which will cause the ACL manager to immediately publish the
current state of ACLs for that endpoint on the relevant subscription.</p>
</div>
<div class="section" id="publication-heartbeat">
<h5>Publication: HEARTBEAT<a class="headerlink" href="#publication-heartbeat" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt></li>
<li><strong>Direction</strong>: ACL Manager → Felix</li>
<li><strong>Body</strong>: An <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt> publication contains the following fields:<ul>
<li><em>issued</em>: A Unix timestamp with millisecond or better precision
indicating when the heartbeat was issued.</li>
</ul>
</li>
</ul>
<p>Each Calico network has a single <tt class="docutils literal"><span class="pre">aclheartbeat</span></tt> subscription running
between the ACL manager and all the Felices. This subscription never has
ACLs published on it. Instead, every 30 seconds the ACL manager
publishes a single heartbeat message.</p>
</div>
</div>
<div class="section" id="id4">
<h4>Structures<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>This section contains any data structures referenced in the above
documentation. For a data structure to be in this section it must be
sufficiently complex that it would interfere with the clarity of the
previous section.</p>
<div class="section" id="object-acl-collection">
<h5>Object: ACL collection<a class="headerlink" href="#object-acl-collection" title="Permalink to this headline">¶</a></h5>
<p>An <em>ACL collection</em> represents a group of ACLs. It takes the following
form:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;v4&quot;: &lt;rules object&gt;,
  &quot;v6&quot;: &lt;rules object&gt;
}
</pre></div>
</div>
<p>The ACLs in the &#8220;v4&#8221; key apply to IPv4 traffic, the ACLs in the &#8220;v6&#8221; key
apply to IPv6 traffic.</p>
<p>The <em>rules</em> objects mentioned here are defined in the section relating
to the Network API later in this document.</p>
</div>
</div>
</div>
</div>
<div class="section" id="calico-network-api">
<h2>Calico Network API<a class="headerlink" href="#calico-network-api" title="Permalink to this headline">¶</a></h2>
<p>The Calico Network API communicates information about the network
topology of a given Calico deployment. This communication runs between
the Calico Plugin and the Calico ACL manager.</p>
<p>This API transfers the following information:</p>
<ul class="simple">
<li>which security groups exist</li>
<li>the security group rules</li>
<li>which security groups endpoints belong to</li>
</ul>
<p>This API is based on a combination request-response and
publish-subscribe model. The request-response portion of the API is used
to initiate one-off synchronisation between the plugin and the ACL
manager, while the publish-subscribe model is used for monitoring of
state changes. Requests can only flow from the ACL manager to the
plugin. The plugin is the only entity that can publish: the ACL manager
subscribes.</p>
<p>This API is transported by ZeroMQs REQ-REP and PUB-SUB socket logic. The
ACL manager MUST have one sending (REQ or DEALER) socket. The Plugin
must have one receiving (REP or ROUTER) socket, from which it will
accept connections from the ACL manager. Additionally, the ACL manager
MUST have one SUB socket, and the plugin MUST have one PUB socket.</p>
<div class="section" id="id5">
<h3>Stories<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p><em>Note: There are relatively few stories here because by and large they
all take the same form: subscribe to some state and get told when it
changes, and ask for all the current state.</em></p>
<div class="section" id="story-1-initial-configuration-update">
<h4>Story 1: Initial Configuration Update<a class="headerlink" href="#story-1-initial-configuration-update" title="Permalink to this headline">¶</a></h4>
<p>This flow can occur when the ACL manager starts up after the Calico
plugin is already running: for example, turning up a new machine or
recovering from machine failure. In this case the ACL manager needs to
resynchronize with the plugin to learn all the applicable state. The
following events occur:</p>
<ol class="arabic">
<li><p class="first">The ACL manager starts up.</p>
</li>
<li><p class="first">It determines that it needs to work out the state of the network, and
so it issues a &#8220;GETGROUPS&#8221; message:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GETGROUPS&quot;</span><span class="p">,</span>
  <span class="s">&quot;issued&quot;</span><span class="p">:</span> <span class="mf">1410276720.54</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The Calico plugin receives the message. It immediately returns a
simple response:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GETGROUPS&quot;</span><span class="p">,</span>
  <span class="s">&quot;rc&quot;</span><span class="p">:</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">,</span>
  <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">The Calico plugin now checks its internal state to find all the
security groups in the system. For each group it issues a
&#8220;GROUPUPDATE&#8221; message on the <tt class="docutils literal"><span class="pre">groups</span></tt> subscription containing the
information about that security group:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;type&quot;: &quot;GROUPUPDATE&quot;,
  &quot;group&quot;: &lt;the UUID of the security group being updated&gt;,
  &quot;rules&quot;: &lt;a rules object as shown below&gt;,
  &quot;members&quot;: &lt;a members object as shown below&gt;,
  &quot;issued&quot;: 1410276720.54
}
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="story-2-security-group-rules-change">
<h4>Story 2: Security Group Rules Change<a class="headerlink" href="#story-2-security-group-rules-change" title="Permalink to this headline">¶</a></h4>
<p>While the system is enabled a user may change the rules that apply to a
security group. This rules change needs to propagate into the ACL
manager so that it can update its state and, if necessary, notify the
Felix agents of configuration changes that need to be made. When a user
changes security group rules, the following events occur:</p>
<ol class="arabic">
<li><p class="first">The user changes some security group rules.</p>
</li>
<li><p class="first">The Calico plugin detects the change in security group rules and
issues a new message on the &#8220;groups&#8221; subscription, with type
&#8220;GROUPUPDATE&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;type&quot;: &quot;GROUPUPDATE&quot;,
  &quot;group&quot;: &lt;the UUID of the security group being updated&gt;,
  &quot;rules&quot;: &lt;a rules object as shown below&gt;,
  &quot;members&quot;: &lt;a members object as shown below&gt;,
  &quot;issued&quot;: 1410276720.54
}
</pre></div>
</div>
<p>This message includes the full security group rules state after the
change: it does <em>not</em> encode deltas.</p>
</li>
<li><p class="first">The ACL manager receives this set of changed security group rules. It
updates it internal state and recalculates any necessary rule
changes. If it finds this change affects connectivity it notifies the
relevant Felixes to update the state they program into the kernel.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="id6">
<h3>Detailed API Description<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id7">
<h4>Request-Response<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<div class="section" id="request-getgroups">
<h5>Request: GETGROUPS<a class="headerlink" href="#request-getgroups" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">GETGROUPS</span></tt></li>
<li><strong>Direction</strong>: ACL Manager → Plugin</li>
<li><strong>Body</strong>: The body of a <tt class="docutils literal"><span class="pre">GETGROUPS</span></tt> request contains the following
fields:<ul>
<li><em>issued</em>: A Unix timestamp with millisecond or better precision
indicating when the request was issued.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="response-getgroups">
<h5>Response: GETGROUPS<a class="headerlink" href="#response-getgroups" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">GETGROUPS</span></tt></li>
<li><strong>Direction</strong>: Plugin → ACL Manager</li>
<li><strong>Body</strong>: The body of a <tt class="docutils literal"><span class="pre">GETGROUPS</span></tt> response contains the following
fields:<ul>
<li><em>rc</em>: A return code indicating whether the plugin is going to
publish the current security group state.</li>
<li><em>message</em>: A free-form text field carrying extra diagnostic
information about the response. Generally expected to be empty on
success.</li>
</ul>
</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">GETGROUPS</span></tt> request-response pair is used to provide one-off
resynchronisation of the current collection of security groups in the
system, including which machines are in which security groups. This
resynchronisation is actually achieved over the Pub-Sub interface: this
message simply triggers that set of messages.</p>
</div>
</div>
<div class="section" id="id8">
<h4>Pub-Sub<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<div class="section" id="publication-groupupdate">
<h5>Publication: GROUPUPDATE<a class="headerlink" href="#publication-groupupdate" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">GROUPUPDATE</span></tt></li>
<li><strong>Direction</strong>: Plugin → ACL Manager</li>
<li><strong>Body</strong>: The body of a <tt class="docutils literal"><span class="pre">GROUPUPDATE</span></tt> publication contains the
following fields:<ul>
<li><em>rules</em>: A single <em>rules</em> object as detailed below. The <tt class="docutils literal"><span class="pre">group</span></tt>
keys within this <em>rules</em> object MUST be set to <tt class="docutils literal"><span class="pre">null</span></tt>.</li>
<li><em>group</em>: The UUID of the security group being updated.</li>
<li><em>members</em>: A single <em>members</em> object as detailed below.</li>
<li><em>issued</em>: A Unix timestamp with millisecond or better precision
indicating when the request was issued.</li>
</ul>
</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">GROUPUPDATE</span></tt> publication is only ever issued on the <tt class="docutils literal"><span class="pre">groups</span></tt>
subscription. It is issued whenever rules in a security group are
changed, and contains the entire rules state for that security group,
including the rules and memberships.</p>
<p>This message is also issued to notify the ACL manager about new security
groups, and to inform it of whem a security group has been removed. New
security groups are notified simply by sending a notification of their
rules and members. The removal of a security group is notified by
sending a <tt class="docutils literal"><span class="pre">GROUPUPDATE</span></tt> for the group with an empty <em>members</em> object.
Security groups without members have no effect on the security topology
and can be considered non-existent.</p>
<p>This message is <em>not</em> segmented into multiple subscriptions, one per
group, the way endpoint ACLs are on the ACL API. This is because we do
not believe that there will be any case where a subscriber of the ACL
API will not want <em>all</em> security group rule changes.</p>
</div>
<div class="section" id="id9">
<h5>Publication: HEARTBEAT<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><strong>Type</strong>: <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt></li>
<li><strong>Direction</strong>: Plugin → ACL Manager</li>
<li><strong>Body</strong>: An <tt class="docutils literal"><span class="pre">HEARTBEAT</span></tt> publication contains the following fields:<ul>
<li><em>issued</em>: A Unix timestamp with millisecond or better precision
indicating when the heartbeat was issued.</li>
</ul>
</li>
</ul>
<p>Each Calico network has a single <tt class="docutils literal"><span class="pre">networkheartbeat</span></tt> subscription
running between the plugin and all the ACL manager. This subscription
never has data published on it. Instead, every 30 seconds the plugin
publishes a single heartbeat message.</p>
<p>This can be used by the ACL manager to determine whether the plugin is
present and the subscription connection is active.</p>
</div>
</div>
<div class="section" id="id10">
<h4>Structures<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>This section contains any data structures referenced in the above
documentation. For a data structure to be in this section it must be
sufficiently complex that it would interfere with the clarity of the
previous section.</p>
<div class="section" id="object-security-groups">
<h5>Object: security groups<a class="headerlink" href="#object-security-groups" title="Permalink to this headline">¶</a></h5>
<p>The <em>security groups</em> object contains a mapping of all security groups
present on the deployment to the endpoints that are in that security
group. This is represented by a JSON object whose keys are security
group UUIDs and whose values are lists of endpoint UUIDs. Each list
element in the value is an endpoint that is present in a security group.</p>
</div>
<div class="section" id="object-rules">
<h5>Object: rules<a class="headerlink" href="#object-rules" title="Permalink to this headline">¶</a></h5>
<p>The <em>rules</em> object contains all of the security group rules associated
with a group. This has the following form:</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;inbound&quot;: &lt;list of rule objects&gt;,
  &quot;outbound&quot;: &lt;list of rule objects&gt;,
  &quot;inbound_default&quot;: &quot;deny&quot;,
  &quot;outbound_default&quot;: &quot;deny&quot;
}
</pre></div>
</div>
<p>Each rule object is detailed below. Each rule represents an <em>exception</em>
to the default policy for that direction, which may be which may only
contain the value &#8220;deny&#8221;. For this object, &#8220;inbound&#8221; represents
connections coming <em>to</em> an endpoint, and &#8220;outbound&#8221; means connections
coming <em>from</em> an endpoint.</p>
</div>
<div class="section" id="object-rule">
<h5>Object: rule<a class="headerlink" href="#object-rule" title="Permalink to this headline">¶</a></h5>
<p>A single <em>rule</em> object represents one security group rule. It&#8217;s a JSON
object with the following keys:</p>
<ul class="simple">
<li><em>group</em>: This rule allows/denies connections coming to/from a
specific security group. If the <em>cidr</em> key is present, this key MUST
be <tt class="docutils literal"><span class="pre">null</span></tt>.</li>
<li><em>cidr</em>: This rule allows/denies connections coming to/from a specific
subnet. If the <em>group</em> key is present, ths key MUST be <tt class="docutils literal"><span class="pre">null</span></tt>.</li>
<li><em>protocol</em>: The network protocol (e.g. &#8220;udp&#8221;). To match all
protocols, send <tt class="docutils literal"><span class="pre">null</span></tt>.</li>
<li><em>port</em>: This rule only affects traffic to/from this port. Should be a
JSON number, or the <tt class="docutils literal"><span class="pre">null</span></tt> (meaning all ports). Must be <tt class="docutils literal"><span class="pre">null</span></tt>
for protocols that do not have ports (e.g. ICMP).</li>
</ul>
<p>Below are some example rules:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">&quot;cidr&quot;</span><span class="p">:</span> <span class="s">&quot;10.65.0.0/24&quot;</span><span class="p">,</span> <span class="s">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">&quot;port:&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">}</span>
</pre></div>
</div>
<p>This rule matches all traffic to/from the 10.65.0.0/24 subnet, in all
protocols, to all ports.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="s">&quot;a935e8e1-008a-4e05-af4b-4b5701df417e&quot;</span><span class="p">,</span> <span class="s">&quot;cidr&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">}</span>
</pre></div>
</div>
<p>This rule matches all traffic to/from a specific security group.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s">&quot;cidr&quot;</span><span class="p">:</span> <span class="s">&quot;0.0.0.0/0&quot;</span><span class="p">,</span> <span class="s">&quot;protocol&quot;</span><span class="p">:</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">:</span> <span class="s">&quot;80&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>This rule matches all TCP traffic to/from any source to port 80.</p>
</div>
<div class="section" id="object-members">
<h5>Object: members<a class="headerlink" href="#object-members" title="Permalink to this headline">¶</a></h5>
<p>The <em>members</em> object contains all of the endpoints belonging to a
specific security group. It takes the form of a key-value set, where the
keys are the IDs of the endpoints in the security group and the values
are the IP addresses associated with that endpoint.</p>
<div class="highlight-python"><div class="highlight"><pre>{
  &quot;&lt;endpoint ID&gt;&quot;: &lt;list of IP addresses&gt;,
  ...
}
</pre></div>
</div>
<p>There is no requirement that each endpoint be in only one security
group, they may be in multiple groups.</p>
</div>
</div>
</div>
</div>
<div class="section" id="return-codes">
<h2>Return Codes<a class="headerlink" href="#return-codes" title="Permalink to this headline">¶</a></h2>
<p>The following is a list of specified return codes for the API:</p>
<ul class="simple">
<li>&#8220;SUCCESS&#8221;</li>
</ul>
</div>
<div class="section" id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We will at some point want a liveness API from Felix. This will be
dealt with in a later revision of the API.</li>
<li>We need to extend the Endpoint API and ACL API to handle the fact
that a single endpoint may be associated with multiple ports, and
that a single port may be associated with multiple endpoints (e.g.
with Cumulus). Right now this is not adequately handled in this API.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Calico API Design</a><ul>
<li><a class="reference internal" href="#general-api-format">General API Format</a></li>
<li><a class="reference internal" href="#calico-endpoint-api">Calico Endpoint API</a><ul>
<li><a class="reference internal" href="#stories">Stories</a><ul>
<li><a class="reference internal" href="#story-1-endpoint-creation">Story 1: Endpoint Creation</a></li>
<li><a class="reference internal" href="#story-2-endpoint-state-update">Story 2: Endpoint State Update</a></li>
<li><a class="reference internal" href="#story-3-failed-endpoint-allocation">Story 3: Failed Endpoint Allocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#detailed-api-description">Detailed API Description</a><ul>
<li><a class="reference internal" href="#request-response">Request-Response</a><ul>
<li><a class="reference internal" href="#request-endpointcreated">Request: ENDPOINTCREATED</a></li>
<li><a class="reference internal" href="#response-endpointcreated">Response: ENDPOINTCREATED</a></li>
<li><a class="reference internal" href="#request-endpointupdated">Request: ENDPOINTUPDATED</a></li>
<li><a class="reference internal" href="#response-endpointupdated">Response: ENDPOINTUPDATED</a></li>
<li><a class="reference internal" href="#request-endpointdestroyed">Request: ENDPOINTDESTROYED</a></li>
<li><a class="reference internal" href="#response-endpointdestroyed">Response: ENDPOINTDESTROYED</a></li>
<li><a class="reference internal" href="#request-resyncstate">Request: RESYNCSTATE</a></li>
<li><a class="reference internal" href="#response-resyncstate">Response: RESYNCSTATE</a></li>
<li><a class="reference internal" href="#request-heartbeat">Request: HEARTBEAT</a></li>
<li><a class="reference internal" href="#response-heartbeat">Response: HEARTBEAT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#structures">Structures</a><ul>
<li><a class="reference internal" href="#object-ip-address">Object: IP Address</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#calico-acl-api">Calico ACL API</a><ul>
<li><a class="reference internal" href="#id1">Stories</a><ul>
<li><a class="reference internal" href="#story-1-acls-for-a-new-endpoint">Story 1: ACLs for a New Endpoint</a></li>
<li><a class="reference internal" href="#story-2-a-change-in-acl-state-of-an-endpoint">Story 2: A change in ACL state of an endpoint</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2">Detailed API Description</a><ul>
<li><a class="reference internal" href="#id3">Request-Response</a><ul>
<li><a class="reference internal" href="#request-getaclstate">Request: GETACLSTATE</a></li>
<li><a class="reference internal" href="#response-getaclstate">Response: GETACLSTATE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pub-sub">Pub-Sub</a><ul>
<li><a class="reference internal" href="#publication-aclupdate">Publication: ACLUPDATE</a></li>
<li><a class="reference internal" href="#publication-heartbeat">Publication: HEARTBEAT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">Structures</a><ul>
<li><a class="reference internal" href="#object-acl-collection">Object: ACL collection</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#calico-network-api">Calico Network API</a><ul>
<li><a class="reference internal" href="#id5">Stories</a><ul>
<li><a class="reference internal" href="#story-1-initial-configuration-update">Story 1: Initial Configuration Update</a></li>
<li><a class="reference internal" href="#story-2-security-group-rules-change">Story 2: Security Group Rules Change</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">Detailed API Description</a><ul>
<li><a class="reference internal" href="#id7">Request-Response</a><ul>
<li><a class="reference internal" href="#request-getgroups">Request: GETGROUPS</a></li>
<li><a class="reference internal" href="#response-getgroups">Response: GETGROUPS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">Pub-Sub</a><ul>
<li><a class="reference internal" href="#publication-groupupdate">Publication: GROUPUPDATE</a></li>
<li><a class="reference internal" href="#id9">Publication: HEARTBEAT</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">Structures</a><ul>
<li><a class="reference internal" href="#object-security-groups">Object: security groups</a></li>
<li><a class="reference internal" href="#object-rules">Object: rules</a></li>
<li><a class="reference internal" href="#object-rule">Object: rule</a></li>
<li><a class="reference internal" href="#object-members">Object: members</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#return-codes">Return Codes</a></li>
<li><a class="reference internal" href="#known-issues">Known Issues</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="faq.html"
                        title="previous chapter">Frequently Asked Questions</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/api-proposal.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="faq.html" title="Frequently Asked Questions"
             >previous</a> |</li>
        <li><a href="index.html">Project Calico 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Metaswitch Networks.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>