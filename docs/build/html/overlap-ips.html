<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Overlapping IPv4 address ranges &mdash; Project Calico 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Project Calico 0.0.1 documentation" href="index.html" />
    <link rel="next" title="Calico with OpenStack" href="openstack.html" />
    <link rel="prev" title="IPv6 support" href="ipv6.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="openstack.html" title="Calico with OpenStack"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ipv6.html" title="IPv6 support"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Project Calico 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="overlapping-ipv4-address-ranges">
<h1>Overlapping IPv4 address ranges<a class="headerlink" href="#overlapping-ipv4-address-ranges" title="Permalink to this headline">¶</a></h1>
<p>This document describes how we can use 464XLAT to allow multiple tenants
within the same data center to use the same IPv4 address ranges
(including actually using the same IPv4 addresses). This is known as
&#8220;overlapping&#8221; IPv4 addresses, and also as &#8220;address space isolation&#8221;,
because it means that an IP address such as 10.10.0.2 (for example) for
one tenant has nothing to do with the same IP address being used by a
different tenant.</p>
<div class="section" id="rfc-6877">
<h2>RFC 6877<a class="headerlink" href="#rfc-6877" title="Permalink to this headline">¶</a></h2>
<p>464XLAT is specified by <a class="reference external" href="https://tools.ietf.org/html/rfc6877">https://tools.ietf.org/html/rfc6877</a> and
describes how an IPv4-based application on a client device can access
IPv4-based services somewhere in the Internet, via an IPv6 network.</p>
<ul>
<li><p class="first">An IPv4 packet sent from the client&#8217;s application is translated
(statelessly, per <a class="reference external" href="https://tools.ietf.org/html/rfc6145">https://tools.ietf.org/html/rfc6145</a>) into an IPv6
packet.</p>
<div class="highlight-python"><div class="highlight"><pre>IPv4 packet           IPv6 packet
SRC 192.168.0.2 ----&gt; SRC 2001:db8:a41:23::192.168.0.2
DST 72.51.34.34       DST 2001:db8:a41:23::72.51.34.34
</pre></div>
</div>
</li>
<li><p class="first">The IPv6 packet is routed over the IPv6 network to the relevant
server.</p>
</li>
<li><p class="first">The IPv6 packet is translated back into an IPv4 packet. This step
needs to be stateful (per <a class="reference external" href="https://tools.ietf.org/html/rfc6146">https://tools.ietf.org/html/rfc6146</a>)
because an arbitrary number of clients can connect to the server, and
it isn&#8217;t possible to map all their possible IPv6 addresses onto a
range of IPv4 addresses in any way that&#8217;s reversible without state.</p>
<div class="highlight-python"><div class="highlight"><pre>IPv6 packet                            IPv4 packet
SRC 2001:db8:a41:23::192.168.0.2 ----&gt; SRC 192.168.11.5
DST 2001:db8:a41:23::72.51.34.34       DST 72.51.34.34
</pre></div>
</div>
</li>
<li><p class="first">The IPv4 packet is delivered to the server application, and the
server application responds.</p>
</li>
<li><p class="first">The response IPv4 packet is translated into an IPv6 packet. This uses
the state established by the incoming packet, in particular to
translate the response packet&#8217;s destination IPv4 address to an IPv6
address.</p>
<div class="highlight-python"><div class="highlight"><pre>IPv4 packet            IPv6 packet
SRC 72.51.34.34  ----&gt; SRC 2001:db8:a41:23::72.51.34.34
DST 192.168.11.5       DST 2001:db8:a41:23::192.168.0.2
</pre></div>
</div>
</li>
<li><p class="first">The response IPv6 packet is routed over the IPv6 network back to the
client.</p>
</li>
<li><p class="first">The response IPv6 packet is translated back into an IPv4 packet.</p>
<div class="highlight-python"><div class="highlight"><pre>IPv6 packet                            IPv4 packet
SRC 2001:db8:a41:23::72.51.34.34 ----&gt; SRC 72.51.34.34
DST 2001:db8:a41:23::192.168.0.2       DST 192.168.0.2
</pre></div>
</div>
</li>
<li><p class="first">The response IPv4 packet is delivered to the client application.</p>
</li>
</ul>
</div>
<div class="section" id="data-center-usage">
<h2>Data center usage<a class="headerlink" href="#data-center-usage" title="Permalink to this headline">¶</a></h2>
<p>The use of 464XLAT for overlapping IPv4 addresses in a data center is
largely similar. In particular:</p>
<ul class="simple">
<li>An IPv4 packet coming from an instance is translated to IPv6 by the
compute host.</li>
<li>The core transport of the data center, i.e. the L3 network connecting
the compute hosts to each other, is IPv6 only.</li>
<li>An IPv6 packet that arrives on a compute host, and that is destined
for an instance on that compute host, is translated back to an IPv4
packet and then routed to the relevant instance.</li>
</ul>
<p>Allowing multiple tenants to use the same IPv4 address ranges is
achieved by including a number in the IPv6 translation that represents
the tenant - or more generally, that represents the address space. So,
an IPv4 address W.X.Y.Z, in address space <tt class="docutils literal"><span class="pre">&lt;ID&gt;</span></tt>, would be mapped to
the IPv6 address:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;prefix&gt;:&lt;ID&gt;::W.X.Y.Z
</pre></div>
</div>
<p>The address space needs to be associated, on each compute host, with the
TAP interfaces of all VM ports whose IPv4 addresses are to be considered
as belonging to that address space. Then, when an IPv4 packet is
received by the compute host on one of those TAP interfaces, it can be
translated to an IPv6 packet whose addresses contain the correct
<tt class="docutils literal"><span class="pre">&lt;ID&gt;</span></tt>.</p>
<p>There are many possible mappings between tenants and address spaces.</p>
<ul class="simple">
<li>Complete tenant isolation corresponds to an address space that is
only allowed to be used by that tenant.</li>
<li>The current non-isolated Calico model corresponds to an address space
that is shared across all tenants.</li>
<li>Between these extremes, it is also possible for an address space to
be shared by a specific group of tenants.</li>
</ul>
<p>Also note that a given tenant may use multiple address spaces - for
example, one that is private to itself, and one that is shared.</p>
</div>
<div class="section" id="compute-host-processing">
<h2>Compute host processing<a class="headerlink" href="#compute-host-processing" title="Permalink to this headline">¶</a></h2>
<p>How might this look in detail, on a given compute host?</p>
<p>TAYGA (<a class="reference external" href="http://www.litech.org/tayga/">http://www.litech.org/tayga/</a>) is an open source daemon that
translates between IPv4 and IPv6. It presents itself as a network
device, to which packets wanting translation should be routed. A packet
received from a VM will pass through Linux routing and iptables
processing twice: once as an IPv4 packet, which routing should direct
into the TAYGA device; and then again as an IPv6 packet, which routing
should forward to the IPv6 next hop.</p>
<p>Routing namespaces may be needed, as the compute host may have VMs using
the same IPv4 addresses in different address spaces; for example two
packets, both addressed to 10.10.0.2 but from different VMs, might need
to be translated using different address space IDs. Possibly this might
be achievable by some marking scheme instead of by using namespaces -
TBD.</p>
<p>To route translated packets across the network between compute hosts,
BGP must distribute IPv6-translated addresses for instances, instead of
the original IPv4 addresses.</p>
<p>So the picture for processing a packet from a VM looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>                   +---------------------+
                   | Compute Host        |
                   |                     |
+----+   TAP i/f   |  +---------------+  |
| VM |-------------|--| IPv4 routing  |  |
+----+ IPv4 packet |  |  and iptables |  |
                   |  +---------------+  |
                   |          |          |
                   |  +---------------+  |
                   |  | TAYGA device  |  |
                   |  | xlate to IPv6 |  |
                   |  +---------------+  |
                   |          |          |
                   |  +---------------+  |
                   |  | IPv6 routing  |  |
                   |  | and ip6tables |--|--- IPv6 next hop
                   |  +---------------+  |
                   |                     |
                   +---------------------+
</pre></div>
</div>
<p>For a packet received on a compute host, the first step is to decide
whether the packet&#8217;s destination IPv6 address maps to one of that
compute host&#8217;s VMs, and if so directing it into the TAYGA device for
translation. This can be done with routing table entries like those that
Calico programs today, but with IPv6 addresses and pointing to TAYGA
instead of down TAP interfaces.</p>
<p>After translation back to IPv4, the traditional Calico routing rules
will route down the correct TAP interface. Except that we have the
namespace problem again: if there are two local VMs with the same
address, which of them should get the packet?</p>
</div>
<div class="section" id="further-study-and-questions">
<h2>Further study and questions<a class="headerlink" href="#further-study-and-questions" title="Permalink to this headline">¶</a></h2>
<p>Further work will be needed on (at least) the following points.</p>
<p>Pin down the use of namespaces and/or an alternative marking scheme, on
the compute host. If multiple namespaces are used, does this require a
separate TAYGA device in each namespace?</p>
<p>One key difference between the RFC 6877 client-server scenario and the
data center scenario is that in the data center case we expect that the
IPv6-&gt;IPv4 translation can be stateless. Broadly, because all of the
possible IPv4 source addresses can be represented as themselves on the
destination compute host. Need to further pin down and describe
precisely whether and why this is true.</p>
<p>How does IPv4&lt;-&gt;6 translation interact with external access? Or, how
does a VM with an overlapped IPv4 address communicate with an IPv4-based
server outside the data center? I think that answering this depends on
first pinning down our more general external access story.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Overlapping IPv4 address ranges</a><ul>
<li><a class="reference internal" href="#rfc-6877">RFC 6877</a></li>
<li><a class="reference internal" href="#data-center-usage">Data center usage</a></li>
<li><a class="reference internal" href="#compute-host-processing">Compute host processing</a></li>
<li><a class="reference internal" href="#further-study-and-questions">Further study and questions</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ipv6.html"
                        title="previous chapter">IPv6 support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="openstack.html"
                        title="next chapter">Calico with OpenStack</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/overlap-ips.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="openstack.html" title="Calico with OpenStack"
             >next</a> |</li>
        <li class="right" >
          <a href="ipv6.html" title="IPv6 support"
             >previous</a> |</li>
        <li><a href="index.html">Project Calico 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Metaswitch Networks.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>