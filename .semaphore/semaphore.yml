version: v1.0
name: Felix
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: Build
  dependencies: []
  task:
    agent:
      machine:
        type: e1-standard-4
        os_image: ubuntu1804
    jobs:
    - name: Build
      commands:
      - checkout
      - cache restore go-pkg-cache
      - cache restore go-mod-cache
      - >-
        make image fv/fv.test bin/test-workload bin/test-connection
        bin/calico-felix
      - 'cache store bin-${SEMAPHORE_GIT_SHA} bin'
      - cache store go-pkg-cache .go-pkg-cache
      - 'cache store go-mod-cache ${HOME}/go/pkg/mod/cache'
      - docker save -o /tmp/calico-felix.tar calico/felix:latest-amd64
      - 'cache store felix-image-${SEMAPHORE_GIT_SHA} /tmp/calico-felix.tar'
- name: FV Tests
  dependencies: ["Build"]
  task:
    prologue:
      commands:
      - checkout
      - cache restore go-pkg-cache
      - cache restore go-mod-cache
      - 'cache restore bin-${SEMAPHORE_GIT_SHA}'
      - 'cache restore felix-image-${SEMAPHORE_GIT_SHA}'
      - docker load -i /tmp/calico-felix.tar
      - rm /tmp/calico-felix.tar
      - touch bin/*
    jobs:
    - name: FV Test matrix
      commands:
      - make fv FV_BATCHES_TO_RUN="${SEMAPHORE_JOB_INDEX}" FV_NUM_BATCHES=${SEMAPHORE_JOB_COUNT}
      parallelism: 8
    - name: Kubernetes FV tests
      commands:
      - make k8sfv-test JUST_A_MINUTE=true USE_TYPHA=${USE_TYPHA}
      matrix:
      - env_var: USE_TYPHA
        values: ["true", "false"]
- name: Unit tests
  dependencies: []
  task:
    prologue:
      commands:
      - checkout
      - cache restore go-pkg-cache
      - cache restore go-mod-cache
    jobs:
    - name: UT and static checks
      commands:
      - make ut
    - name: Static checks
      commands:
      - make static-checks
