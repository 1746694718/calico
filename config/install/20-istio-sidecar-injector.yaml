---
apiVersion: v1
kind: Secret
metadata:
  creationTimestamp: null
  name: sidecar-injector-certs
  namespace: istio-system
data:
  cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUU4VENDQXRtZ0F3SUJBZ0lVTUQ4bkpDb0FNcTFmTzRXekR1dG9uTVNBL3Jvd0RRWUpLb1pJaHZjTkFRRU4KQlFBd1NURUxNQWtHQTFVRUJoTUNWVk14Q3pBSkJnTlZCQWdNQWtOQk1SVXdFd1lEVlFRS0RBeFVhV2RsY21FcwpJRWx1WXk0eEZqQVVCZ05WQkFNTURXTnNkWE4wWlhJdWJHOWpZV3d3SGhjTk1UZ3dNekl5TWpFMU9EQXdXaGNOCk1Ua3dNekl5TWpFMU9EQXdXakF5TVRBd0xnWURWUVFERXlkcGMzUnBieTF6YVdSbFkyRnlMV2x1YW1WamRHOXkKTG1semRHbHZMWE41YzNSbGJTNXpkbU13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQgpBUUMzY2ZRWG5VNVZvZ3luWkQrU3F3eE9VTEZWazNpVi9xdk42SjFibFo0b0FmK0RhM21oYzI2SW52R1lzaHlkCkkrVVczemZVM292OERrbjFtMStQdzY3UDBrYWx5QVpEdWo3RElxL1lYSE1tZTdCY2p1MGFzbXFMV1QrN0c2aCsKemlwQlNnWWNiUGp0OUg4Ymx6RE4vWnk4VG85TWNPcVFjYzZ0VVRyVzFzS0pVVS9yRmNsM1NLRCtKTml5cnIzVgpuQnBLR2tQVEpsWlo0ZFZ1UlYrRU55c1VxRE4zWGZtZUxZSERSUGJoL0NtbE9mZW9tTmU5ODRqZ0QwTG9iY1A2ClRNcGRkdHpyM3MzRjNKVTJzYTg1WWFxaUdxTFdOWE04cFBFai92dEhIMzk1ZVJrWFhwWnpEMk9aYWVIOHV2dkYKWkdzcDBHN1RkZXFzNVV2c2NVTSt4dUVMQWdNQkFBR2pnZWN3Z2VRd0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNRwpBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNQXdHQTFVZEV3RUIvd1FDTUFBd0hRWURWUjBPQkJZRUZBOFBoU3FPCmE2ait0SXA1VkxGL21KUUlYK3JETUI4R0ExVWRJd1FZTUJhQUZBRit4d1h0VWMxbTZ0OEVTa3NsbXloRWdERGUKTUc4R0ExVWRFUVJvTUdhQ0ZtbHpkR2x2TFhOcFpHVmpZWEl0YVc1cVpXTjBiM0tDSTJsemRHbHZMWE5wWkdWagpZWEl0YVc1cVpXTjBiM0l1YVhOMGFXOHRjM2x6ZEdWdGdpZHBjM1JwYnkxemFXUmxZMkZ5TFdsdWFtVmpkRzl5CkxtbHpkR2x2TFhONWMzUmxiUzV6ZG1Nd0RRWUpLb1pJaHZjTkFRRU5CUUFEZ2dJQkFGNlZ1SlhWSnhTMDVjWkIKam1uRFlobHZ4SElLcEZLM3VnTlpyZG1WZkUrS3dxci9VK09ZSktFS3lKS09iK20rV1B2aktsUkpUSmNyYllGVwpGbXQ4N25rWW9qL3BaUkZMUldOMlZnT2NwR0g3UWZHYzNqaUpNYTBPZkpQRjZoVlJ3bVFLbE5uSTNaTXRxRlE1ClJUVXg5aUZoeXNCSHRFZDlNRUEyK3o4RG15M2lmRFRUQnZEcyszVVJmdjhURjh4ZnNvZkF3R3lpUUZvWlNNOVEKRDN0MlRsTGowbnZ2QWFjS0Y0T1huRTFaVWowdUZKazl3ZE1KSEdaZGowZjdkTFBFc1BvQUNzbjhGZnZCZTZLZgpha2M4RGk0bWNlSGo4WmpWZmpEeGlZV3JBcU9rQ0U1bG91cU50SGNXNlVMMXFEYStFYzJoMzdIc1JDb3pyUGszClpvMkllVDIxTEpkK2lnaFQzNjB6YzVyRFFDYTJnQUNSelZ0d3hSY2lwTXRIMTg1NGxkUzlKY2hTaHA4NHhYU0EKd0pxVkcvSmJhUUJCZjc4K3IxMzAzUkZ1RkJnUGVhM3NTYmQ1YUg3S1lyNzh4T0VnN1Z6YUI1bG1HNmM4aFpRbgpmUTZXaG9QZHRmdDZCRnc5VnpQUEE5QjIrMFhFd1A3SkNUMEd1UjAzTFkwRUlzZlBUbUFsQ3J3RWNRcmxJZGlDCm5RV1hJOHdOdkJTa0VIbHVtSTZET3F4cVFXVndWTVZMWlFLR1VkU2kxRlQzeXFlVmRJMGRBM3k3YklLSGZEMlkKKzUrTTRhc0owLzZGZ1Vma2x6WkE5WTJ3akZjMU5uR0xhVSsveHhTeTU5UXpEejBaQmtVclI1N1ROYXBHMXZiSgpEcW5yMlVoRXhLdi90dWJGMXhZNVdYUlNtU2UvCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdDNIMEY1MU9WYUlNcDJRL2txc01UbEN4VlpONGxmNnJ6ZWlkVzVXZUtBSC9nMnQ1Cm9YTnVpSjd4bUxJY25TUGxGdDgzMU42TC9BNUo5WnRmajhPdXo5SkdwY2dHUTdvK3d5S3YyRnh6Sm51d1hJN3QKR3JKcWkxay91eHVvZnM0cVFVb0dIR3o0N2ZSL0c1Y3d6ZjJjdkU2UFRIRHFrSEhPclZFNjF0YkNpVkZQNnhYSgpkMGlnL2lUWXNxNjkxWndhU2hwRDB5WldXZUhWYmtWZmhEY3JGS2d6ZDEzNW5pMkJ3MFQyNGZ3cHBUbjNxSmpYCnZmT0k0QTlDNkczRCtrektYWGJjNjk3TnhkeVZOckd2T1dHcW9ocWkxalZ6UEtUeEkvNzdSeDkvZVhrWkYxNlcKY3c5am1XbmgvTHI3eFdScktkQnUwM1hxck9WTDdIRkRQc2JoQ3dJREFRQUJBb0lCQUNHYWNURW1NcVJERS9oUgp4OGR4Sjhic3h4ODY3VnJrbE1vYU0wRUVqajBiNkpkRlI3bUljSlg4TDV0ZC9Sblg2bTRmSTVZTjBpeXczV0Z0ClBic1RDR0d2VGh1dUlWK2tyVHlIalJpZ0RzUGM0bmlDQWZMaS9kdGExTzdNYVRnWlFlcEZ5Z3JJOTJ4M1hoVksKdzdqb0hSN3RjUmg2a3EwMCs3d0o1akpXa3JvZWFGVXdqYzlvOVNqZHVvQzArT1Bnc0FpdU1WZllseEFyNXBOagpheUFMcE8xcFJsbmp0MElVL3kwMWtJS0d0MGdyc05WSldQbjl4YWpzRkJjaDl5c0lpUEsxSks4WXBkcCtyRDlDClE3SlM4ejNOZUI5LytMVnZIbXB3TXphdnFTNm4yYXVnWFNOcEV6U2F1UDQ4ZmhxR1lJaVJ3YTVya2JQUGxDYXgKREVWZ3Bia0NnWUVBNnFma0pkMTRnYW9sV3Rtb2crd3prYnM3UFAvT3NwdkM4WjIwZ0ZGZ3ZKNlNDT3ZCK0F1awozRUIyMkZzYmZGUWV3Wmh5L3RIM2p5SmFMTjgxdUdyZ0Z4S1dkUEFBbDlQcEVjQzMxcDNzSndzUkRKV293NUsvCkVRUnR2dmNaMnhJdTZIRVFvWjU4NkJ4S2F1SDQwdWx2cm9CcEtkNFZieERLYSsvVEhNS1k1NVVDZ1lFQXlDR1cKeCtySmI0aDYySDBiRnhJZ0xuUld1R1MyYUV1UkJoT3lCVHRFQkxaUHYwMGJJNnlzRDVoL1pUY3BlNWN6U1ZITgpUWGxaY3JNb1I4MkNZREp2WGNhNkh0WDlIR1U0VDhzTXNxaVV3M3U2SEw4QVkyQ2hmYjNqWW9IUk9zRmlpUjFXClBEcTdxd2NkYlR0d1BzSlFVd0FQVFBrRW5WRE5aMjhWU25OSi9oOENnWUJ5MzV2MTJYVEw3Vko2SmtHenkyYjMKZWJRblNZZVRzbUw5eTFsNDA5M0ttTW9lNmVNOEhkOG9IN3JPY2RPRHl0NS9vYlR5QURIejlUbzE2MU91STB2dQpuNS9lUVR2WkY5bHFZbkRjOU5TTnpJSWRLZ3JESzB5ejlQb1EyWURqMlFQenNKNFdzTEt2SW1KZjdwM1VDb2tzCjRSb2FiK2tJUlMwREtCV3VaNmxZL1FLQmdRQzBuOFFqU045bS8ybklMQm1nRitiZHBuaUNVYnRqcEJnT3dRWGgKdk55bDJCbGZrZXJWcHNsZ0JnV3N4ejEwWTBHUmdmZm1YWWlDZ2ZudjNDWTRSaXpIR1UzditMaEp3WDB5WHhObAp4OHNFSjQ0UTFiNDI4d2F0b3cwdllmVUJyM29NUUdNTlZ3RDcyaDhQOEI1ZE5pa2kwQ0gvR1p5MWt6RGZrcDFICnBZZjVod0tCZ1FDNGhURjA1dUF4eElOK1U5akVoNVJkU2ZWdEZaaEhSOU1rdWxpODZ3RGc5MnFZRzJvNzhHYzUKdmZXZGtYdE1ZbGgrbC91Y3BZWW1VL3JoRnY4WU9GaUVVbllrcmdxZWtueDUyTnhDNlJMcTA0clFxeGJZa3cxSwpQMlJyS2owbWdtNnNtS0lGSlJ6WndSc3pkU2NIN1dESU1FczE1SEIrd1BST0ozZTJrUlJWM2c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
# DO NOT USE THIS IN PRODUCTION!!! This key and the signing key are checked into a public github repo. For demos only.
---
kind: ConfigMap
metadata:
  name: istio-inject
  namespace: istio-system
apiVersion: v1
data:
  config: |
    policy: enabled
    template: |-
      initContainers:
      - name: istio-init
        image: docker.io/istio/proxy_init:0.6.0
        args:
        - "-p"
        - {{ .MeshConfig.ProxyListenPort }}
        - "-u"
        - 1337
        imagePullPolicy: IfNotPresent
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
          privileged: true
        restartPolicy: Always
      - args:
        - -c
        #/etc/istio/proxy value here matches ConfigPathDir const in context.go
        - sysctl -w kernel.core_pattern=/etc/istio/proxy/core.%e.%p.%t && ulimit -c
          unlimited
        command:
        - /bin/sh
        image: alpine
        imagePullPolicy: IfNotPresent
        name: enable-core-dump
        resources: {}
        securityContext:
          privileged: true
      containers:
      - name: istio-proxy
        image: quay.io/spikecurtis/istio-proxy_debug:20180322211709
        args:
        - proxy
        - sidecar
        - --configPath
        - {{ .ProxyConfig.ConfigPath }}
        - --binaryPath
        - {{ .ProxyConfig.BinaryPath }}
        - --serviceCluster
        {{ if ne "" (index .ObjectMeta.Labels "app") -}}
        - {{ index .ObjectMeta.Labels "app" }}
        {{ else -}}
        - "istio-proxy"
        {{ end -}}
        - --drainDuration
        - {{ formatDuration .ProxyConfig.DrainDuration }}
        - --parentShutdownDuration
        - {{ formatDuration .ProxyConfig.ParentShutdownDuration }}
        - --discoveryAddress
        - {{ .ProxyConfig.DiscoveryAddress }}
        - --discoveryRefreshDelay
        - {{ formatDuration .ProxyConfig.DiscoveryRefreshDelay }}
        - --zipkinAddress
        - {{ .ProxyConfig.ZipkinAddress }}
        - --connectTimeout
        - {{ formatDuration .ProxyConfig.ConnectTimeout }}
        - --statsdUdpAddress
        - {{ .ProxyConfig.StatsdUdpAddress }}
        - --proxyAdminPort
        - {{ .ProxyConfig.ProxyAdminPort }}
        - --controlPlaneAuthPolicy
        - {{ .ProxyConfig.ControlPlaneAuthPolicy }}
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: USE_EDS_V1
          value: 1
        imagePullPolicy: IfNotPresent
        securityContext:
            privileged: true
            readOnlyRootFilesystem: false
            runAsUser: 1337
        restartPolicy: Always
        volumeMounts:
        - mountPath: /etc/istio/proxy
          name: istio-envoy
        - mountPath: /etc/certs/
          name: istio-certs
          readOnly: true
        - mountPath: /var/run/dikastes
          name: dikastes-sock
      - name: dikastes
        image: quay.io/calico/dikastes:20180328162858
        args: ["/dikastes", "server", "-l", "/var/run/dikastes/dikastes.sock", "-d", "/var/run/felix/nodeagent/socket", "--debug"]
        volumeMounts:
        - mountPath: /var/run/dikastes
          name: dikastes-sock
        - mountPath: /var/run/felix
          name: felix-sync
      volumes:
      - emptyDir:
          medium: Memory
        name: istio-envoy
      - name: istio-certs
        secret:
          optional: true
          {{ if eq .Spec.ServiceAccountName "" }}secretName: istio.default{{ else }}secretName: {{ printf "istio.%s" .Spec.ServiceAccountName }}{{ end }}
      - name: dikastes-sock
        emptyDir:
          medium: Memory
      - name: felix-sync
        flexVolume:
          driver: nodeagent/uds
---
apiVersion: v1
kind: Service
metadata:
  name: istio-sidecar-injector
  namespace: istio-system
  labels:
    istio: sidecar-injector
spec:
  ports:
  - name: https-webhook # optional
    port: 443
  selector:
    istio: sidecar-injector
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: istio-sidecar-injector-service-account
  namespace: istio-system
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: istio-sidecar-injector
  namespace: istio-system
  labels:
    istio: sidecar-injector
spec:
  replicas: 1
  template:
    metadata:
      name: istio-sidecar-injector
      labels:
        istio: sidecar-injector
    spec:
      serviceAccountName: istio-sidecar-injector-service-account
      containers:
        - name: webhook
          image: docker.io/istio/sidecar_injector:0.6.0
          imagePullPolicy: IfNotPresent
          args:
            - --tlsCertFile=/etc/istio/certs/cert.pem
            - --tlsKeyFile=/etc/istio/certs/key.pem
            - --injectConfig=/etc/istio/inject/config
            - --meshConfig=/etc/istio/config/mesh
            - --healthCheckInterval=1s
            - --healthCheckFile=/health
          volumeMounts:
          - name: config-volume
            mountPath: /etc/istio/config
            readOnly: true
          - name: certs
            mountPath: /etc/istio/certs
            readOnly: true
          - name: inject-config
            mountPath: /etc/istio/inject
            readOnly: true
          livenessProbe:
            exec:
              command:
                - /usr/local/bin/sidecar-injector
                - probe
                - --probe-path=/health
                - --interval=2s
            initialDelaySeconds: 4
            periodSeconds: 4
          readinessProbe:
            exec:
              command:
                - /usr/local/bin/sidecar-injector
                - probe
                - --probe-path=/health
                - --interval=2s
            initialDelaySeconds: 4
            periodSeconds: 4
      volumes:
      - name: config-volume
        configMap:
          name: istio
      - name: certs
        secret:
          secretName: sidecar-injector-certs
      - name: inject-config
        configMap:
          name: istio-inject
          items:
          - key: config
            path: config
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: istio-sidecar-injector
webhooks:
  - name: sidecar-injector.istio.io
    clientConfig:
      service:
        name: istio-sidecar-injector
        namespace: istio-system
        path: "/inject"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZyVENDQTVXZ0F3SUJBZ0lKQUt1S0VBREg0QnV0TUEwR0NTcUdTSWIzRFFFQkN3VUFNRWt4Q3pBSkJnTlYKQkFZVEFsVlRNUXN3Q1FZRFZRUUlEQUpEUVRFVk1CTUdBMVVFQ2d3TVZHbG5aWEpoTENCSmJtTXVNUll3RkFZRApWUVFEREExamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRFM01Ea3dOekU0TlRJd00xb1hEVEl3TURZd016RTROVEl3Ck0xb3dTVEVMTUFrR0ExVUVCaE1DVlZNeEN6QUpCZ05WQkFnTUFrTkJNUlV3RXdZRFZRUUtEQXhVYVdkbGNtRXMKSUVsdVl5NHhGakFVQmdOVkJBTU1EV05zZFhOMFpYSXViRzlqWVd3d2dnSWlNQTBHQ1NxR1NJYjNEUUVCQVFVQQpBNElDRHdBd2dnSUtBb0lDQVFDWjFOSmY2YXA5TVNzYVcvd3VSelV5bmNHZENXZHFyZXh3L2NNTjZXKzcwckRHCjB0TmxWVWd4NmIzY1JDTW1qbHpoV1FYNGZYdEtzd1hyUVpDM1VNTkVCeGZJSVBBSSswU1Yxc2Rtakl5SWVWclEKbVJHL09OK0xRcFhSdzdaa2pELzhtUFdDZC81SWZNSXpwanp3bVd0ODREMS9iRHNoeUIzblJieFZTbUhxczVQQgpxNHk2R1NFSlluOEdjc2g5blJPL0YxWXIzTzhlNTQ5UERTMWJsL3RZeUdxWUJ3V3VpdlMxMWIvQ2h6dVE5TkJsCjFiWmZMeFlJbVkzOThWVlU0NE5qSnRVTnpZR0ljd3M5YU5NczFoOVc3NkhoWU5CM0lmTUZOOXBVeWxzcjhjRUwKTkJUYXRVa3B0NjZRcGRNS3ZYOW1WOHhYWlVqZENpTzFhNG9uQ0YwZU5wS3FFRVBnR0M4RGdYcUs1MEN3Uy9rOApjYW1YWHVGcjN3THRtc3AxYlluY1FRTXdISDk5dno1RlJ6N2JaRkVtOGk3YlJVWS9wUmZZNk9wS1NYV0hoR29UCllxaDJubDVwak04aHNaV0Z6aWtuVlZpWUNwRzZDOUx3WS8zSXFvc1dtZTVXWXFiQ0Q2SlZmSzYySkZjbHo2Q0oKN3ZacnF3VjlhRFdrUTN1U3dEU1BtOEsrclJCUHBMOCtmZlN4Ky9XdEpsNCt1YTRncWZITUNCU1ZTMHBmbEV4RgpaMmx5Y0hWMlZ5YytESDI1QWlxSnFrOHRhdjladkdKRlVpNlFMN2oxT2NTMVZVNGFoRmNZWVBMclQyZXVKWGJMCjhOR0k4b1Z1b2J5Q3ZmSmZubytlTVBMcW0vbExBaHJXNjFrSVR5WEk5SnhWMVRXZlgwZEtyUVFuOVh6eDB3SUQKQVFBQm80R1hNSUdVTUIwR0ExVWREZ1FXQkJRQmZzY0Y3VkhOWnVyZkJFcExKWnNvUklBdzNqQWZCZ05WSFNNRQpHREFXZ0JRQmZzY0Y3VkhOWnVyZkJFcExKWnNvUklBdzNqQU1CZ05WSFJNRUJUQURBUUgvTUVRR0ExVWRFUVE5Ck1EdUNDbXQxWW1WeWJtVjBaWE9DRW10MVltVnlibVYwWlhNdVpHVm1ZWFZzZElJTlkyeDFjM1JsY2k1c2IyTmgKYkljRUNtUUFBWWNFckJJU1pUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FnRUFIMzg4SUdHdmpuNFFvSWRTZE16WQp0amliYUppT0ZheWNMYzhpWmlTY0Vlemd6aEhPSFV2dGhTUnFIV01QQ2N3RGxTRTNta1dmMFpJQ1JtNVJiYlZjCmpjNGd2TU5zdDlRVGgraUxxNDUyaWRCMGdZOVpWY2xSV0M3T21JM25IVmhnaDd1a1ZiMXdpTU82YjFKdlNYR1EKelZ4bmxlUkNXZEp2c0g3MjgySTlWMEJnVVhUSTh0RjR6WkVLeUtCdDV5Q21FREJtTjVtYjJSbTFCMjVYRXJIagpkd3FnL01UK0VFMFBkTVprSlkxRFZIc1czUllBWmlYVlpGNkFOR252WXJBVWdFVHFHTjVsU2NLa1E4KzBKZ25aClZQU2NEKy9MM2o3TnJNQm52YWR2OGVWZ0E1a3c4NWRvZEdjZTFoU0t6eEJSY2QrWGRLdHJDbUZjam1pWGdYUm0KaVZhOEZ4Y1NpclNCUzJNR3ZHMzlrTDZuaENLOUN0L0xGVWFHWm43SXF2OFprMEkzSGlldmJ6cE90WGlVaG5TSQpuS0VMZFV0U3k3eEgzekl1MWRId2RjZUZUUTJnWitEWDRleGpxY2N2ckYyTmtwcFJYcjQ0QzdDRmFPYWM4empECjZkRG1VdU5qNXRHT2lwYXRnbTFDUnZvbE96dDlURERxQnFaYkFqbGVHNEJqZzVDY09YZDlqdXpzMGlzcjkyZWsKSkJUQThzbFVHNFpSQTNya2NEMjEyaEdIK3hNYi9odXJGd2ZsVExEL2Y1azBkVVVjdC9GUUZnSEdFMDVkRUpqaQpQRVZpaVoyTEJvNnI1dkMxVmMxQlhaSTdhV20zcEdVNUxaWVU3Yzg4RHE2SytENm9uZFh5Z2RrcDAxRmpQV0xmCkRDZ1JQL0xaQU1ua2FGOWo0UU96UVdZPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    rules:
      - operations: [ "CREATE" ]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    namespaceSelector:
      matchLabels:
        istio-injection: enabled
---
apiVersion: v1
kind: Namespace
metadata:
  name: default
  labels:
    istio-injection: enabled
